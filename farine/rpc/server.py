#-*- coding:utf-8 -*-
"""
RPC over AMQP implementation: server side.
"""

from kombu import Connection, Producer, Queue
from kombu.mixins import ConsumerMixin

rpc_queue = Queue('rpc_queue')


class Worker(ConsumerMixin):
      _producer_connection = None
  
      def __init__(self, connection):
          self.connection = connection
  
      def get_consumers(self, Consumer, channel):
          return [Consumer(
              queues=[rpc_queue],
              on_message=self.on_request,
              accept={'application/json'},
              prefetch_count=1,
          )]
  
      def on_request(self, message):
          n = message.payload['n']
          print(' [.] fib({0})'.format(n))
          result = fib(n)
  
          with Producer(self.producer_connection) as producer:
              producer.publish(
                  {'result': result},
                  exchange='', routing_key=message.properties['reply_to'],
                  correlation_id=message.properties['correlation_id'],
                  serializer='json',
              )
          message.ack()
  
      def on_consume_end(self, connection, channel):
          if self._producer_connection is not None:
              self._producer_connection.close()
              self._producer_connection = None
  
      @property
      def producer_connection(self):
          if self._producer_connection is None:
              conn = self.connection.clone()
              conn.ensure_connection(self.on_connection_error,
                                     self.connect_max_retries)
              self._producer_connection = conn
          return self._producer_connection
  
  
def start_worker(broker_url):
    connection = Connection(broker_url)
    worker = Worker(connection)
    worker.run()
